name: Deploy Tussak Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd server
          pip install -r requirements.txt
      
      - name: ê¸°ë³¸ ë¬¸ë²• ì²´í¬
        run: |
          cd server
          python -m py_compile app.py
          echo "âœ… Python ë¬¸ë²• ì²´í¬ í†µê³¼!"
  
  deploy:
    needs: test
    runs-on: self-hosted
    
    steps:
      - name: ë°°í¬ ì‹œì‘ ì•Œë¦¼
        run: |
          echo "ğŸš€ Tussak ì„œë²„ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          echo "í˜„ì¬ ì‹œê°: $(date)"
      
      - name: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          cd /home/tussak/Tussak/server
          bash deploy.sh
      
      - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        run: |
          sleep 3
          sudo systemctl status tussak-app --no-pager
      
      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "âœ… Tussak ì„œë²„ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ì™„ë£Œ ì‹œê°: $(date)"
